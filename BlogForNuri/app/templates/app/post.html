{% extends "app/layout.html" %}

{% block content %}

<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8" />
    <title>{{ post.title }}</title>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-md-10 mx-auto">
                <h1>{{ post.title }}</h1>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-md-10 mx-auto">
                {{ post.content }}
                <div class="meta">
                    <span>Автор текста</span>
                    <a href="/blogger/{{ post.author.id }}/">{{ post.author }}</a>
                </div>
                <button type="button" id="likeButton" class="btn btn-primary" data-action="like" data-id="{{ post.id }}" aria-pressed="false">Мне нравится 
                <span data-count="like">{{post.total_likes}}</span>
                </button>    
            </div>
            {% if user.is_authenticated and user == post.author %}
            <div class="d-grid gap-2 d-md-flex justify-content-md-end"> 
                <!-- Надо передлать кнопку для отправки формы -->
                <form method="POST">{% csrf_token %}
                    <button type="submit" class="btn btn-primary">Редактировать</button>
                    <!-- Кнопка вызывающая modal -->
                    <button type='button' class="btn btn-danger" data-toggle="modal" data-target="#delModal">Удалить</button>
                </form>
            </div>
            {% endif %}
        </div>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="delModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="delModalLabel">Удаление поста</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Вы действительно хоите удалить запись?</p>
                </div>
                <div class="modal-footer">
                    <form action="{% url "post_delete" post_id=post.id %}" method="POST">{% csrf_token %}
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Отменить</button>
                        <button type="submit" class="btn btn-danger">Удалить</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script>

// Получение переменной cookie по имени
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
 
// Настройка AJAX
$(function () {
    $.ajaxSetup({
        headers: { "X-CSRFToken": getCookie("csrftoken") }
    });
});

function like() {
    var like = $(this);
    var pk = like.data('id');
    var action = like.data('action');
 
    $.ajax({
        url: "/post/" + pk + "/" + action + "/",
        type : 'POST',
        data : { 'obj' : pk },
 
        success : function (json) {
            like.find("[data-count='like']").text(json.like_count);
        }
    });
 
    return false;
}

  $('#likeButton').click(like);
</script>

{% endblock %}